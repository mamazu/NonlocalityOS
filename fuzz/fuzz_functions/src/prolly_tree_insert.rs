use arbitrary::Unstructured;
use astraea::{storage::InMemoryTreeStorage, tree::BlobDigest};
use pretty_assertions::assert_eq;
use std::collections::BTreeMap;
use tokio::sync::Mutex;

async fn insert_one_at_a_time(entries: &[(u32, i64)], storage: &InMemoryTreeStorage) -> BlobDigest {
    let mut current_state = sorted_tree::prolly_tree::new_tree::<u32, i64>(storage)
        .await
        .expect("creating a new tree should succeed");
    let mut oracle = BTreeMap::new();
    for (key, _value) in entries.iter() {
        let found = sorted_tree::prolly_tree::find::<u32, i64>(storage, &current_state, key).await;
        assert_eq!(None, found);
    }
    for (key, value) in entries.iter() {
        {
            let existing_entry =
                sorted_tree::prolly_tree::find::<u32, i64>(storage, &current_state, key).await;
            let expected_entry = oracle.get(key);
            assert_eq!(expected_entry.copied(), existing_entry);
        }
        {
            let number_of_trees_before = storage.number_of_trees().await;
            current_state = sorted_tree::prolly_tree::insert::<u32, i64>(
                storage,
                storage,
                &current_state,
                *key,
                *value,
                sorted_tree::prolly_tree::default_is_split_after_key::<u32>,
            )
            .await
            .expect("inserting key should succeed");
            let number_of_trees_after = storage.number_of_trees().await;
            assert!(number_of_trees_after >= number_of_trees_before);
            let difference = number_of_trees_after - number_of_trees_before;
            // TODO: find out why so many trees are created in some cases
            assert!(difference <= 100);
        }
        let found = sorted_tree::prolly_tree::find::<u32, i64>(storage, &current_state, key).await;
        assert_eq!(Some(*value), found);
        oracle.insert(*key, *value);
        let size = sorted_tree::prolly_tree::size::<u32, i64>(storage, &current_state).await;
        assert_eq!(Some(oracle.len() as u64), size);
        assert_eq!(
            Some(sorted_tree::prolly_tree::IntegrityCheckResult::Valid(
                if oracle.is_empty() {
                    None
                } else {
                    Some((
                        *oracle.first_entry().unwrap().key(),
                        *oracle.last_entry().unwrap().key(),
                    ))
                }
            )),
            sorted_tree::prolly_tree::verify_integrity::<u32, i64>(storage, &current_state,).await
        );
    }
    for (key, value) in oracle.iter() {
        let found = sorted_tree::prolly_tree::find::<u32, i64>(storage, &current_state, key).await;
        assert_eq!(Some(*value), found);
    }
    let final_size = sorted_tree::prolly_tree::size::<u32, i64>(storage, &current_state).await;
    assert_eq!(Some(oracle.len() as u64), final_size);
    let number_of_trees = storage.number_of_trees().await;
    assert!(number_of_trees >= (1 + oracle.len()));
    // TODO: find a better upper bound
    assert!(number_of_trees <= 10000);
    current_state
}

async fn insert_all_at_once(entries: &[(u32, i64)], storage: &InMemoryTreeStorage) -> BlobDigest {
    let mut current_state = sorted_tree::prolly_tree::new_tree::<u32, i64>(storage)
        .await
        .expect("creating a new tree should succeed");
    let mut oracle = BTreeMap::new();
    for (key, value) in entries.iter() {
        oracle.insert(*key, *value);
    }
    {
        let number_of_trees_before = storage.number_of_trees().await;
        current_state = sorted_tree::prolly_tree::insert_many::<u32, i64>(
            storage,
            storage,
            &current_state,
            entries.to_vec(),
            sorted_tree::prolly_tree::default_is_split_after_key::<u32>,
        )
        .await
        .expect("inserting key should succeed");
        let number_of_trees_after = storage.number_of_trees().await;
        assert!(number_of_trees_after >= number_of_trees_before);
        let difference = number_of_trees_after - number_of_trees_before;
        assert!(difference <= 10);
        assert_eq!(
            Some(sorted_tree::prolly_tree::IntegrityCheckResult::Valid(
                if oracle.is_empty() {
                    None
                } else {
                    Some((
                        *oracle.first_entry().unwrap().key(),
                        *oracle.last_entry().unwrap().key(),
                    ))
                }
            )),
            sorted_tree::prolly_tree::verify_integrity::<u32, i64>(storage, &current_state,).await
        );
    }
    for (key, value) in oracle.iter() {
        let found = sorted_tree::prolly_tree::find::<u32, i64>(storage, &current_state, key).await;
        assert_eq!(Some(*value), found);
    }
    let final_size = sorted_tree::prolly_tree::size::<u32, i64>(storage, &current_state).await;
    assert_eq!(Some(oracle.len() as u64), final_size);
    let number_of_trees = storage.number_of_trees().await;
    assert!(number_of_trees >= (1 + oracle.len()));
    // TODO: find a better upper bound
    assert!(number_of_trees <= 10000);
    current_state
}

async fn insert_entries(entries: &[(u32, i64)]) {
    let storage = astraea::storage::InMemoryTreeStorage::new(Mutex::new(BTreeMap::new()));
    let one_at_a_time_digest = insert_one_at_a_time(entries, &storage).await;
    let all_at_once_digest = insert_all_at_once(entries, &storage).await;
    if one_at_a_time_digest != all_at_once_digest {
        println!(
            "One at a time: {:?}",
            sorted_tree::prolly_tree::load_in_memory_node::<u32, i64>(
                &storage,
                &one_at_a_time_digest
            )
            .await
        );
        println!(
            "All at once:   {:?}",
            sorted_tree::prolly_tree::load_in_memory_node::<u32, i64>(
                &storage,
                &all_at_once_digest
            )
            .await
        );
        // TODO: solve bug https://github.com/TyRoXx/NonlocalityOS/issues/352
        // panic!("Digests do not match");
    }
}

pub fn fuzz_function(data: &[u8]) -> bool {
    let mut unstructured = Unstructured::new(data);
    let entries: Vec<(u32, i64)> = match unstructured.arbitrary() {
        Ok(success) => success,
        Err(_) => return false,
    };
    tokio::runtime::Builder::new_current_thread()
        .build()
        .unwrap()
        .block_on(async {
            insert_entries(&entries).await;
        });
    true
}

#[cfg(test)]
#[test_log::test(tokio::test)]
async fn test_insert_many_entries_zero() {
    insert_entries(&[]).await;
}

#[cfg(test)]
#[test_log::test(tokio::test)]
async fn test_insert_many_entries_same_entry() {
    insert_entries(&[(10, 100), (10, 100), (10, 100), (10, 100), (10, 100)]).await;
}

#[cfg(test)]
#[test_log::test(tokio::test)]
async fn test_insert_many_entries_few() {
    insert_entries(&[
        (10, 100),
        (20, 200),
        (15, 150),
        (25, 250),
        (5, 50),
        (30, 300),
        (12, 120),
        (10, 200),
        (15, 250),
        (12, 220),
        (18, 180),
        (22, 220),
    ])
    .await;
}

#[cfg(test)]
#[test_log::test(tokio::test)]
async fn test_insert_many_entries_lots() {
    insert_entries(
        &(0..200)
            .map(|i| (i, (i as i64) * 10))
            .collect::<Vec<(u32, i64)>>(),
    )
    .await;
}

#[test]
fn crash_0() {
    assert!(fuzz_function(&[
        15, 42, 255, 113, 113, 113, 169, 169, 169, 169, 169, 169, 169, 169, 255, 0, 255, 1, 3, 255,
        255, 255, 255, 35, 35, 35, 35, 35, 35, 35, 255, 255, 255, 255, 255, 255, 255, 255, 35, 35,
        222, 219, 219, 219, 219, 255, 255, 101, 255, 255, 255, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        35, 166, 35, 35, 35, 35, 35, 255, 255, 35, 255, 255, 255, 3, 35, 35, 35, 35, 35, 36, 218,
        181, 186, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255, 255, 255, 255, 255, 113, 255, 255,
        255, 35, 35, 35, 219, 219, 219, 219, 219, 255, 255, 255, 255, 255, 35, 35, 35, 35, 35, 35,
        34, 255, 255, 255, 255, 255, 255, 255, 255, 255, 151, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 0, 6, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 35, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255, 255, 255, 255, 113, 255, 255, 255, 255,
        35, 35, 27, 11, 50, 50, 51, 228, 255, 124, 124, 124, 255, 255, 255, 255, 219, 219, 219,
        219, 219, 219, 219, 219, 219, 219, 219, 255, 113, 219, 219, 219, 219, 219, 219, 219, 219,
        219, 219, 255, 255, 255, 3, 2, 2, 219, 219, 219, 219, 219, 35, 35, 255, 35, 255, 255, 255,
        255, 255, 35, 35, 35, 35, 35, 35, 255, 255, 35, 35, 35, 35, 2, 2, 255, 219, 219, 219, 219,
        219, 219, 219, 219, 219, 219, 219, 255, 113, 219, 219, 219, 219, 219, 219, 219, 219, 219,
        219, 219, 219, 219, 219, 219, 219, 219, 213, 219, 219, 219, 35, 35, 35, 124, 124, 255, 255,
        255, 255, 51, 255, 255, 35, 35, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255, 255, 255, 219,
        219, 219, 219, 219, 219, 255, 35, 255, 255, 255, 255, 255, 35, 219, 219, 219, 219, 219,
        255, 11, 113, 219, 219, 219, 219, 219, 219, 219, 37, 164, 36, 253, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 219, 219, 219, 255, 113, 219, 219, 219, 219, 219, 219, 219, 255,
        51, 255, 255, 255, 51, 255, 255, 35, 35, 35, 35, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255,
        255, 255, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 255, 113, 219, 219, 219,
        219, 219, 219, 219, 219, 219, 219, 255, 255, 255, 3, 2, 2, 219, 219, 219, 219, 219, 35, 35,
        35, 255, 35, 255, 255, 255, 255, 255, 35, 35, 35, 35, 35, 35, 255, 255, 35, 35, 35, 35, 2,
        2, 255, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 255, 113, 219, 219, 219,
        219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 213, 219, 219, 219,
        35, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255, 35, 35, 35, 35, 35, 124, 124, 255, 255, 255,
        255, 51, 255, 255, 35, 35, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255, 255, 255, 219, 219,
        219, 219, 219, 219, 255, 35, 255, 255, 255, 255, 255, 35, 219, 219, 219, 219, 219, 255, 11,
        113, 219, 219, 219, 219, 219, 219, 219, 37, 164, 36, 253, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 219, 219, 219, 255, 113, 219, 219, 219, 219, 219, 219, 219, 219, 219,
        219, 2, 2, 219, 219, 219, 219, 219, 35, 35, 255, 35, 255, 255, 255, 255, 255, 255, 51, 124,
        255, 35, 35, 35, 35, 35, 35, 255, 255, 35, 35, 51, 35, 2, 2, 255, 219, 219, 219, 219, 219,
        219, 219, 219, 219, 219, 219, 255, 113, 219, 219, 219, 219, 219, 219, 219, 219, 255, 255,
        2, 219, 219, 219, 219, 219, 35, 35, 255, 35, 255, 252, 255, 255, 255, 35, 35, 35, 35, 35,
        35, 255, 255, 35, 35, 35, 35, 166, 35, 35, 0, 0, 0, 0, 0, 0, 255, 255, 51, 255, 255, 35,
        35, 35, 35, 35, 35, 166, 35, 35, 35, 35, 35, 255, 255, 255, 255, 219, 219, 0, 0, 35, 35,
        35, 35, 219, 219, 219, 218, 219, 219, 35, 219, 35, 2
    ]));
}

#[test]
fn crash_1() {
    assert!(fuzz_function(&[
        49, 245, 28, 69, 71, 69, 69, 69, 69, 69, 69, 69, 69, 69, 26, 228, 56, 38, 69, 69, 69, 69,
        207, 69, 69, 255, 69, 215, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 215, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 207, 207, 207, 207, 207, 207, 207, 207, 228, 52, 38,
        69, 69, 69, 69, 207, 69, 69, 255, 69, 215, 146, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69,
        255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 69, 69, 215, 179, 10, 3, 69, 141, 92, 190, 50, 97, 104, 168, 88, 73, 41, 141, 70, 122,
        193, 47, 219, 56, 255, 105, 60, 129, 51, 230, 213, 85, 139, 197, 32, 84, 176, 254, 170, 56,
        38, 69, 69, 69, 69, 207, 69, 69, 255, 69, 215, 146, 179, 125, 125, 125, 125, 125, 125, 125,
        125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125,
        125, 125, 125, 125, 125, 125, 10, 3, 69, 69, 69, 69, 69, 69, 69, 255, 255, 255, 255, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137,
        137, 137, 137, 137, 137, 137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 3, 137, 137, 137, 137, 137,
        137, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 149, 149, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 223, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 207, 207, 207, 207, 207, 207, 207, 228, 50,
        46, 69, 69, 69, 69, 207, 69, 69, 255, 69, 215, 146, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69,
        255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 126, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 137, 137,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 239, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137,
        137, 137, 137, 137, 207, 207, 207, 207, 207, 207, 207, 228, 50, 46, 69, 69, 69, 69, 207,
        69, 69, 255, 69, 215, 146, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69, 255, 255, 255, 255, 149,
        149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 149, 126, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 137, 137, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137,
        137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137, 137, 137,
        137, 137, 137, 137, 255, 255, 255, 3, 137, 137, 137, 137, 137, 137, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 220, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 255, 247, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 223, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 255, 255, 255, 255, 255, 41,
        255, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 8, 255, 255, 127, 0
    ]));
}

#[test]
fn crash_2() {
    assert!(fuzz_function(&[
        49, 245, 28, 69, 255, 6, 69, 69, 69, 69, 69, 69, 69, 69, 26, 228, 56, 38, 69, 69, 69, 69,
        207, 69, 69, 255, 69, 215, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 215, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 207, 207, 207, 207, 207, 207, 207, 207, 228, 52, 38,
        69, 69, 69, 69, 207, 69, 69, 255, 69, 215, 146, 179, 10, 3, 69, 69, 69, 69, 69, 69, 69,
        255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 69, 69, 215, 179, 10, 96, 69, 141, 92, 190, 50, 97, 104, 168, 88, 73, 41, 141, 70,
        122, 193, 47, 219, 56, 255, 105, 60, 129, 51, 230, 213, 85, 139, 197, 32, 84, 176, 254,
        170, 56, 38, 69, 69, 69, 69, 207, 69, 69, 255, 69, 215, 146, 179, 125, 125, 125, 125, 125,
        125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125,
        125, 125, 125, 125, 125, 125, 125, 125, 10, 3, 69, 69, 69, 69, 69, 69, 69, 255, 255, 255,
        255, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137,
        137, 137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 3, 137, 137, 137,
        137, 137, 137, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 137, 137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 255, 125,
        125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125,
        125, 125, 125, 125, 125, 125, 10, 3, 69, 69, 69, 69, 69, 69, 69, 255, 255, 255, 255, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 107, 107, 107, 107,
        139, 148, 148, 148, 107, 107, 107, 107, 107, 71, 62, 109, 87, 25, 23, 175, 41, 141, 90,
        233, 139, 141, 49, 229, 35, 91, 180, 229, 106, 154, 212, 46, 128, 64, 184, 170, 50, 221,
        92, 212, 60, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107,
        107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107,
        107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107,
        107, 107, 107, 107, 107, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 255, 255,
        255, 3, 137, 137, 137, 137, 137, 137, 149, 149, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 223, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137,
        137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 149, 149, 149, 149, 149, 149, 149, 149, 151,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 149, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 137, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137,
        137, 255, 255, 255, 3, 137, 137, 137, 137, 137, 137, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 113,
        255, 255, 255, 255, 10, 65, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81,
        81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 81, 65, 65, 65, 65, 65,
        65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 137, 65, 65, 65, 65,
        65, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 223, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 255, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137,
        137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 149, 149, 149, 149, 149, 149, 149, 149,
        149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149,
        255, 255, 255, 8, 255, 255, 127, 0
    ]));
}

#[test]
fn crash_3() {
    assert!(fuzz_function(&[164]));
}

#[test]
fn crash_4() {
    assert!(fuzz_function(&[
        15, 42, 219, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255
    ]));
}

#[test]
fn crash_5() {
    assert!(fuzz_function(&[
        49, 245, 28, 69, 71, 255, 255, 69, 69, 56, 38, 69, 69, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 127, 0, 255, 255, 127
    ]));
}

#[test]
fn crash_6() {
    assert!(fuzz_function(&[
        15, 42, 255, 113, 113, 113, 169, 169, 169, 169, 169, 169, 169, 169, 255, 0, 247, 1, 3, 255,
        255, 255, 255, 35, 35, 35, 35, 35, 35, 35, 255, 255, 0, 0, 0, 0, 255, 255, 35, 35, 222,
        219, 219, 219, 219, 255, 255, 101, 255, 255, 255, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,
        166, 35, 35, 35, 35, 35, 255, 255, 35, 255, 255, 255, 3, 35, 35, 35, 35, 35, 36, 116, 218,
        181, 186, 35, 35, 166, 1, 0, 0, 0, 35, 255, 255, 255, 255, 255, 255, 113, 255, 255, 255,
        35, 35, 35, 219, 219, 219, 219, 219, 255, 255, 255, 255, 255, 35, 35, 35, 35, 35, 35, 34,
        255, 255, 255, 255, 255, 255, 255, 255, 255, 151, 255, 255, 255, 255, 255, 255, 255, 255,
        255, 255, 255, 255, 255, 219, 219, 219, 218, 219, 219, 35, 219, 35, 2
    ]));
}

#[test]
fn crash_7() {
    assert!(fuzz_function(&[
        15, 255, 10, 255, 255, 255, 48, 16, 10, 0, 0, 0, 255, 255, 255, 1, 0, 127, 255, 255, 255,
        255, 255, 137, 30, 18, 145, 166, 172, 151, 251, 143, 150, 193, 121, 73, 104, 69, 54, 5,
        226, 198, 223, 149, 149, 149, 149, 149, 149, 149, 69, 69, 69, 69, 207, 69, 69, 255, 69, 1,
        1, 255, 255, 255, 255, 39, 255, 39, 255, 69, 69, 69, 69, 207, 69, 69, 255, 69, 1, 1, 255,
        255, 255, 255, 39, 255, 255, 1, 56, 255, 105, 69, 69, 255, 255, 255, 255, 39, 254, 255,
        255, 146, 69, 69, 69, 215, 146, 179, 125, 125, 125, 125, 125, 125, 125, 1, 1, 255, 255,
        255, 255, 39, 255, 69, 69, 69, 69, 207, 69, 69, 255, 255, 255, 39, 255, 39, 255, 69, 69,
        69, 69, 255, 39, 255
    ]));
}
